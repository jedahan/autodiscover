<script src=http://localhost:3000/socket.io/socket.io.js ></script>
<script>
  const socket = io.connect(`http://localhost:3000`)

  const assertEq = (expected, actual, why) => {
    let equals = expected === actual
    if (Array.isArray(expected) && Array.isArray(actual)) {
      equals = (expected.length == actual.length) &&
        expected.every((el, idx) => JSON.stringify(el) == JSON.stringify(actual[idx]))
    }
    console.assert(equals, why, expected, actual)
  }

  const gorogstart = 'gorog is at 0.5, 0.7'
  const gorogmove = 'gorog is at 0.8, 0.4'
  const gorogstartparsed = {name: {word: "gorog"}, x: {value: 0.5}, y:{value: 0.7}}
  const gorogmoveparsed = {name: {word: "gorog"}, x: {value: 0.8}, y:{value: 0.4}}

  // subscribe to an interesting sentence
  const initialselections = JSON.stringify(['$name is at $x, $y'])
  setTimeout(() => {
    let timesChanged = 0
    socket.on(initialselections, ({assertions, retractions}) => {
      if (timesChanged === 0) {
        assertEq([], assertions, "asserted:gorogstart:previousassertions")
        assertEq([], retractions, "asserted:gorogstart:previousretractions")
      } else if (timesChanged === 1) {
        assertEq([gorogstartparsed], assertions, "asserted:gorogstart:assertions")
        assertEq([], retractions, "asserted:gorogstart:retractions")
      } else if (timesChanged === 2) {
        assertEq([gorogmoveparsed], assertions, "asserted:gorogmove:assertions")
        assertEq([], retractions, "asserted:gorogmove:retractions")
      } else if (timesChanged === 3) {
        assertEq([], assertions, "asserted:gorogmove:assertions")
        assertEq([gorogstartparsed], retractions, "retracted:gorogstart:retractions")
        console.log(`tests passed!`)
      }
      timesChanged++
    })
    socket.emit('subscribe', initialselections)
  }, 050)

  setTimeout(() => {
    socket.emit('assert', [gorogstart])
  }, 100)
  setTimeout(() => {
    socket.emit('assert', [gorogmove])
  }, 200)
  setTimeout(() => {
    socket.emit('retract', [gorogstart])
  }, 300)

</script>
