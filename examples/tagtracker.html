<head>
  <style>
    canvas { background-color: rgba(58, 67, 84, 0.7) }
  </style>
</head>
<body>
  <h3> this uses <a href="https://github.com/jedahan/colorTracker">colorTracker</a></h3>
  <canvas id="canvas"></canvas>
  <script src=http://localhost:3000/socket.io/socket.io.js ></script>
  <script>
    let labels = new Map()
    context = canvas.getContext('2d')
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
    context.font="40px sans-serif"

    const socket = io.connect(`http://localhost:3000`)

    socket.on('subscriptionFacts', ({queries, solutions}) => {
      performance.mark('subscriptionFacts')
      solutions.forEach( solution => {
        let [label, x, y] = [solution.id.id, solution.x.value, solution.y.value]
        labels.set(label, {x, y})
        const retraction = `#${label} is a label at (${x}, ${y})`
        socket.emit('retract', [ retraction ])
      })
    })

    socket.on('connection', data => {
      socket.emit('updateSubscription', `$id is a label at ($x, $y)`)
      socket.emit('assert', ['#fake is a label at (0.5, 0.5)'])
    })

    let fps = 60
    let now
    let then = Date.now()
    let interval = 1000/fps
    let delta

    async function draw (time) {
      requestAnimationFrame(draw)

      now = Date.now()
      delta = now - then

      if (delta > interval) {
        context.clearRect(0, 0, canvas.width, canvas.height)

        for (label of labels.keys()) {
          const { x, y } = labels.get(label)
          context.fillText(label, x * canvas.width, y * canvas.height)
        }
      }
    }

    draw()
  </script>
</body>
